---
title: "County Health Rankings"
output: html_notebook
---

This is an analysis of the Robert Wood Johnson Foundation County Health Rankings.

Setting the working directory
```{r set wd}
setwd("C:/Users/natek/Documents/County Health Rankings Analysis")
```

Loading libraries
```{r libraries, message = FALSE}
library(tidyverse)
```

I tried reading in the 2014, 2015, 2016, and 2017 data. Unfortunately, all of them are messy datasets and will need to be cleaned up individually before combining any of them. So I'll start with 2017 and return to the others later. 

There are two columns that caused difficulty for 'read_csv()`, so I read them in as characters and will fix them if they're required for the analysis  
```{r data}
chr_df_17 = read_csv("data/2017CHR_CSV_Analytic_Data.csv",
                       col_types = cols(
                       measure_127_value = col_character(),
                       measure_131_value = col_character()
                       )
                      )

chr_df_17 = chr_df_17 %>% rename(FIPS = fipscode) #renaming a variable for use in the function below

```

Next I'll take just our peer cities and add columns indicating baseline or current peer

```{r}

pull_all_peers <- function(data){
  data = data %>% filter(data$FIPS == 1073 |data$FIPS == 37119
                       |data$FIPS == 39061 |data$FIPS == 39049
                       |data$FIPS == 26081 |data$FIPS == 37081
                       |data$FIPS == 45045 |data$FIPS == 18097
                       |data$FIPS == 29095 |data$FIPS == 47093
                       |data$FIPS == 21111 |data$FIPS == 47157
                       |data$FIPS == 47037 |data$FIPS == 40109
                       |data$FIPS == 31055 |data$FIPS == 29189
                       |data$FIPS == 29510
                       |data$FIPS == 40143 |data$FIPS == 39113
                       |data$FIPS == 12031 |data$FIPS == 37183
                       |data$FIPS == 37183 |data$FIPS == 51760)
  
    data$baseline <- 1
    data$current <- 1
    data$baseline[data$FIPS==26081|data$FIPS==29189
                       |data$FIPS==29510|data$FIPS==40109
                       |data$FIPS==40143|data$FIPS==45045
                       |data$FIPS==47093] <- 0
    data$current[data$FIPS== 12031|data$FIPS==37183|
                        data$FIPS==39113|data$FIPS==51760] <- 0
  data
}

chr_df_17 <- pull_all_peers(chr_df_17)

```

Now renaming everything to have useful names and also selecting only the data needed for the analysis. The names are taken from the dataset documentation which I've copied into the repo. 

```{r}
chr_df_17 <- chr_df_17 %>%
  select(
    premature_death = measure_1_value,
    poor_or_fair_health = measure_2_value,
    poor_physical_health_days = measure_36_value,
    poor_mental_health_days = measure_42_value,
    low_birthweight = measure_37_value,
    adult_smoking = measure_9_value,
    adult_obesity = measure_11_value,
    food_environment_index = measure_133_value,
    physical_inactivity = measure_70_value,
    access_to_exercise_opportunities = measure_132_value,
    excessive_drinking = measure_49_value,
    alcohol_impaired_driving_deaths = measure_134_value,
    sexually_transmitted_infections = measure_45_value,
    teen_births = measure_14_value,
    uninsured = measure_85_value,
    primary_care_physicians = measure_4_value,
    dentists = measure_88_value,
    mental_health_providers = measure_62_value,
    preventable_hospital_stays = measure_5_value,
    diabetes_monitoring = measure_7_value,
    mammography_screening = measure_50_value,
    high_school_graduation = measure_21_value,
    some_college = measure_69_value,
    unemployment = measure_23_value,
    children_in_poverty = measure_24_value,
    income_inequality = measure_44_value,
    children_in_single_parent_households = measure_82_value,
    social_associations = measure_140_value,
    violent_crime = measure_43_value,
    injury_deaths = measure_135_value,
    air_pollution = measure_125_value,
    drinking_water = measure_124_value,
    severe_housing_problems = measure_136_value,
    driving_alone_to_work = measure_67_value,
    long_commute = measure_137_value,
    FIPS, current, baseline
  )

```

Taking only our peer cities. 

```{r}
chr_df_17 <- chr_df_17 %>% filter(current ==1)
```

Taking Z scores for everything. I wrote a simple function to take z-scores and then applied it to all columns except FIPS, current, and baseline. 

```{r}
chr_z <- chr_df_17

norm_z <- function(x){
  z <- (x - mean(x))/sd(x)
}

chr_z[,1:35] <- apply(chr_z[,1:35], 2, norm_z) 
```

Creating overall rankings for outcomes and each of the four health factors based on weighted average.
In general, higher scores indicate less healthy, except for the following list, all of which will have their z-scores multiplied by -1 to be consistent.
*Food environment index
*Access to exercise opportunities
*Diabetic Monitoring
*Mammography Screening
*High School Graduation
*Some college
*Social associations

Also note that the factor weights add up to one for all four factors. However, relative weights are consistent even though within each of the four health factors they don't follow common practice of adding to 1. Since this will be rescaled on a 0 to 1 scale stretching from least healthy to healthiest peer, this shouldn't be a problem. But it does mean they shouldn't be reweighted when all four are added together. 

```{r}
chr_z <- chr_z %>%
  mutate(
    outcomes = premature_death*.5+
      poor_or_fair_health*.1+
      poor_physical_health_days*.1+
      poor_mental_health_days*.1+
      low_birthweight*.1,
    health_behaviors = adult_smoking*.1+
      adult_obesity*.05+
      food_environment_index*-.02+
      physical_inactivity*.02+
      access_to_exercise_opportunities*-.01+
      excessive_drinking*.025+
      alcohol_impaired_driving_deaths*.025+
      sexually_transmitted_infections*.025+
      teen_births*.025,
    clinical_care = uninsured*.05+
      primary_care_physicians*.03+
      dentists*.01+
      mental_health_providers*.01+
      preventable_hospital_stays*.05+
      diabetes_monitoring*-.025+
      mammography_screening*.025,
    social_and_economic = high_school_graduation*.05+
      some_college*.05+
      unemployment*.10+
      children_in_poverty*.075+
      income_inequality*.025+
      children_in_single_parent_households*.025+
      social_associations*-.025+
      violent_crime*.025+
      injury_deaths*.025,
    physical_environment = 
      air_pollution*.025 +
      drinking_water*.025 +
      severe_housing_problems*.02 +
      driving_alone_to_work * .02 +
      long_commute * .01,
    factors = health_behaviors+clinical_care+social_and_economic+physical_environment
  )
```

Adding city names instead of just FIPS codes


